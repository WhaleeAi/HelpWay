<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Заявка на помощь | HelpWay</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .form__group--with-suggestions { position: relative; }
    .form__suggestions { position: absolute; left: 0; right: 0; top: 100%; z-index: 20; background: #fff; border: 1px solid #dcdcdc; border-radius: 8px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); max-height: 240px; overflow-y: auto; margin-top: 4px; padding: 4px 0; }
    .form__suggestions[hidden] { display: none; }
    .form__suggestions-group { padding: 6px 12px; font-weight: 600; color: #555; border-bottom: 1px solid #f1f1f1; background: #f9fafb; }
    .form__suggestions-item { padding: 10px 12px; cursor: pointer; }
    .form__suggestions-item:hover { background: #f3f4f6; }
    .form__suggestions-empty { padding: 10px 12px; color: #777; }
  </style>
</head>

<body class="page-application">
  <header class="header">
    <div class="container header__inner">
      <a class="logo" href="client.html">HelpWay</a>
      <div class="header__actions">
        <a class="btn btn--outline" href="client.html">На главную</a>
      </div>
    </div>
  </header>

  <main class="register">
    <div class="container">
      <div class="register__card">
        <h1 class="register__title">Заявка на помощь</h1>
        <p class="register__lead">Заполните информацию о клиенте и выберите учреждение для визита.</p>

        <form id="applicationForm" class="form" novalidate>
          <div class="form__group">
            <label>Тип ограничений клиента</label>
            <div class="form__options">
              <label class="form__option">
                <input type="checkbox" name="limitations" value="Маломобильность" />
                Маломобильность
              </label>
              <label class="form__option">
                <input type="checkbox" name="limitations" value="Пожилой возраст" />
                Пожилой возраст
              </label>
              <label class="form__option">
                <input type="checkbox" name="limitations" value="Проблемы со зрением" />
                Проблемы со зрением
              </label>
              <label class="form__option">
                <input type="checkbox" name="limitations" value="Проблемы со слухом" />
                Проблемы со слухом
              </label>
            </div>
          </div>

          <div class="form__group">
            <label for="comment">Комментарий</label>
            <textarea id="comment" name="comment" placeholder="Дополнительные сведения о клиенте"></textarea>
          </div>

          <div class="form__group">
            <label for="start_address">Адрес клиента</label>
            <input id="start_address" name="start_address" type="text" placeholder="Москва, ..." required />
          </div>

          <div class="form__group">
            <label for="go_date">Дата визита</label>
            <input id="go_date" name="go_date" type="date" required />
          </div>

          <div class="form__group form__group--with-suggestions">
            <label for="institution">Учреждение</label>
            <input id="institutionSearch" type="text" class="form__input" placeholder="Поиск учреждения по названию" autocomplete="off" />
            <select id="institution" name="institution" required>
              <option value="">Загрузка списка...</option>
            </select>
            <div id="institutionSuggestions" class="form__suggestions" hidden></div>
            <div class="form__hint">Список формируется из поликлиник, МФЦ и управ.</div>
          </div>

          <div class="form__group">
            <label>Выберите учреждение на карте</label>
            <div id="applicationMap" class="map"></div>
            <div class="form__hint">Нажмите на метку, чтобы выбрать учреждение.</div>
          </div>

          <button class="btn btn--primary" href="client.html" type="submit">Отправить заявку</button>
          <p class="form__status" id="appStatus" aria-live="polite"></p>
        </form>
      </div>
    </div>
  </main>

  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=0ef553e7-67a5-434b-9c61-f75cca415b38"></script>
  <script>
    (() => {
      const form = document.getElementById("applicationForm");
      const statusEl = document.getElementById("appStatus");
      const institutionSelect = document.getElementById("institution");
      const institutionSearch = document.getElementById("institutionSearch");
      const suggestionsBox = document.getElementById("institutionSuggestions");
      const dateInput = document.getElementById("go_date");
      const mapContainer = document.getElementById("applicationMap");
      let map;
      const userId = localStorage.getItem("user_id");
      let institutionsData = { mfc: [], polyclinic: [], uprava: [] };
      let institutionSearchQuery = "";

      const today = new Date();
      dateInput.value = today.toISOString().slice(0, 10);

      const renderInstitutionOptions = (query = "", preferredValue = null) => {
        const q = (query || "").trim().toLowerCase();
        const previousValue = preferredValue || institutionSelect.value;
        institutionSelect.innerHTML = "";

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Выберите учреждение...";
        institutionSelect.appendChild(placeholder);

        const addGroup = (label, items, type) => {
          if (!items || !items.length) return;
          const filtered = items.filter((item) => {
            const name = (item.name || `${label} #${item.id}`).toLowerCase();
            return !q || name.includes(q);
          });
          if (!filtered.length) return;
          const group = document.createElement("optgroup");
          group.label = label;
          filtered.forEach((item) => {
            const option = document.createElement("option");
            option.value = `${type}:${item.id}`;
            option.textContent = item.name || `${label} #${item.id}`;
            group.appendChild(option);
          });
          institutionSelect.appendChild(group);
        };

        addGroup("МФЦ", institutionsData.mfc, "mfc");
        addGroup("Поликлиника", institutionsData.polyclinic, "polyclinic");
        addGroup("Управа", institutionsData.uprava, "uprava");

        if (institutionSelect.children.length === 1) {
          placeholder.textContent = q ? "Совпадений не найдено" : "Учреждений нет";
          institutionSelect.value = "";
          return;
        }

        if (previousValue && institutionSelect.querySelector(`option[value="${previousValue}"]`)) {
          institutionSelect.value = previousValue;
        } else {
          institutionSelect.value = "";
        }
      };

      const renderSuggestions = (query = "", preferredValue = null) => {
        if (!suggestionsBox) return;
        const q = (query || "").trim().toLowerCase();
        const matches = [];

        const pushItems = (items, type, groupLabel) => {
          if (!items || !items.length) return;
          items.forEach((item) => {
            const label = item.name || `${groupLabel} #${item.id}`;
            if (!q || label.toLowerCase().includes(q)) {
              matches.push({
                value: `${type}:${item.id}`,
                label,
                group: groupLabel
              });
            }
          });
        };

        pushItems(institutionsData.mfc, "mfc", "МФЦ");
        pushItems(institutionsData.polyclinic, "polyclinic", "Поликлиника");
        pushItems(institutionsData.uprava, "uprava", "Управа");

        suggestionsBox.innerHTML = "";

        if (!q) {
          suggestionsBox.hidden = true;
          return;
        }

        if (!matches.length) {
          suggestionsBox.innerHTML = `<div class="form__suggestions-empty">Совпадений не найдено</div>`;
          suggestionsBox.hidden = false;
          return;
        }

        const fragment = document.createDocumentFragment();
        let currentGroup = "";
        matches.slice(0, 15).forEach((item) => {
          if (item.group !== currentGroup) {
            currentGroup = item.group;
            const groupEl = document.createElement("div");
            groupEl.className = "form__suggestions-group";
            groupEl.textContent = currentGroup;
            fragment.appendChild(groupEl);
          }
          const optionEl = document.createElement("div");
          optionEl.className = "form__suggestions-item";
          optionEl.textContent = item.label;
          optionEl.dataset.value = item.value;
          optionEl.addEventListener("mousedown", (evt) => {
            evt.preventDefault();
            const value = optionEl.dataset.value;
            institutionSearch.value = item.label;
            institutionSearchQuery = item.label;
            renderInstitutionOptions(institutionSearchQuery, value);
            renderSuggestions(institutionSearchQuery, value);
            institutionSelect.value = value;
            suggestionsBox.hidden = true;
          });
          fragment.appendChild(optionEl);
        });

        suggestionsBox.appendChild(fragment);
        suggestionsBox.hidden = false;
      };

      const loadInstitutions = async () => {
        try {
          const response = await fetch("api/institutions.php");
          if (!response.ok) {
            throw new Error("Не удалось загрузить учреждения");
          }
          const data = await response.json();
          institutionsData = {
            mfc: Array.isArray(data.mfc) ? data.mfc : [],
            polyclinic: Array.isArray(data.polyclinics) ? data.polyclinics : [],
            uprava: Array.isArray(data.upravas) ? data.upravas : []
          };

          const mapPoints = [];
          const collectPoints = (items, type) => {
            if (!items || !items.length) return;
            items.forEach((item) => {
              if (item.lat != null && item.lon != null) {
                mapPoints.push({
                  id: item.id,
                  type,
                  name: item.name || `${type} #${item.id}`,
                  address: item.address || "",
                  lat: Number(item.lat),
                  lon: Number(item.lon)
                });
              }
            });
          };

          collectPoints(institutionsData.mfc, "mfc");
          collectPoints(institutionsData.polyclinic, "polyclinic");
          collectPoints(institutionsData.uprava, "uprava");

          renderInstitutionOptions(institutionSearchQuery, institutionSelect.value);
          renderSuggestions(institutionSearchQuery, institutionSelect.value);

          initMap(mapPoints);
        } catch (error) {
          institutionSelect.innerHTML = "";
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "Ошибка загрузки учреждений";
          institutionSelect.appendChild(option);
          console.error(error);
        }
      };

      const initMap = (points) => {
        if (!mapContainer) return;
        if (!window.ymaps) return;
        ymaps.ready(() => {
          const center = points.length ? [points[0].lat, points[0].lon] : [55.751244, 37.618423];
          map = new ymaps.Map("applicationMap", {
            center,
            zoom: 11
          });

          points.forEach((p) => {
            const placemark = new ymaps.Placemark([p.lat, p.lon], {
              balloonContent: `<strong>${p.name}</strong><br>${p.address}`
            }, {
              preset: "islands#blueIcon"
            });
            placemark.events.add("click", () => {
              const value = `${p.type}:${p.id}`;
              const label = p.name || `${p.type} #${p.id}`;
              if (institutionSearch) {
                institutionSearch.value = label;
                institutionSearchQuery = label;
              }
              renderInstitutionOptions(institutionSearchQuery, value);
              renderSuggestions(institutionSearchQuery, value);
              institutionSelect.value = value;
              if (suggestionsBox) suggestionsBox.hidden = true;
            });
            map.geoObjects.add(placemark);
          });
        });
      };

      loadInstitutions();

      if (institutionSearch) {
        institutionSearch.addEventListener("input", () => {
          institutionSearchQuery = institutionSearch.value;
          renderInstitutionOptions(institutionSearchQuery, institutionSelect.value);
          renderSuggestions(institutionSearchQuery, institutionSelect.value);
        });
        institutionSearch.addEventListener("focus", () => {
          if (institutionSearch.value.trim()) {
            renderSuggestions(institutionSearch.value, institutionSelect.value);
          }
        });
        document.addEventListener("click", (evt) => {
          if (!suggestionsBox) return;
          if (!suggestionsBox.contains(evt.target) && evt.target !== institutionSearch) {
            suggestionsBox.hidden = true;
          }
        });
      }

      institutionSelect.addEventListener("change", () => {
        const selected = institutionSelect.selectedOptions[0];
        if (selected && institutionSearch) {
          institutionSearch.value = selected.textContent || "";
          institutionSearchQuery = institutionSearch.value;
          renderInstitutionOptions(institutionSearchQuery, selected.value);
          renderSuggestions(institutionSearchQuery, selected.value);
          if (suggestionsBox) suggestionsBox.hidden = true;
        }
      });

      const loadUserAddress = async () => {
        if (!userId) return;
        try {
          const res = await fetch(`api/profile.php?user_id=${encodeURIComponent(userId)}`);
          const text = await res.text();
          if (!res.ok) return;
          const data = JSON.parse(text);
          if (data.address) {
            form.start_address.value = data.address;
            }
          } catch (err) {
            console.error(err);
          }
        };

      loadUserAddress();

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusEl.classList.remove("form__status--error");

        const limitations = Array.from(form.querySelectorAll('input[name="limitations"]:checked'))
          .map((input) => input.value.trim())
          .filter(Boolean);

        if (!limitations.length) {
          statusEl.classList.add("form__status--error");
          statusEl.textContent = "Выберите хотя бы одно ограничение.";
          return;
        }

        const institutionValue = institutionSelect.value;
        if (!institutionValue) {
          statusEl.classList.add("form__status--error");
          statusEl.textContent = "Выберите учреждение.";
          return;
        }

        const [endType, endId] = institutionValue.split(":");
        const userId = localStorage.getItem("user_id");

        if (!userId) {
          statusEl.classList.add("form__status--error");
          statusEl.textContent = "Сначала войдите в систему.";
          return;
        }

        statusEl.textContent = "Отправляем заявку...";

        const payload = {
          user_id: Number(userId),
          type: limitations.join(", "),
          comment: form.comment.value.trim(),
          start_address: form.start_address.value.trim(),
          end_id: Number(endId),
          end_type: endType,
          go_date: form.go_date.value
        };

        try {
          const response = await fetch("api/application.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const body = await response.text();
          if (!response.ok) {
            let msg = "Сервер вернул ошибку";
            try {
              const errJson = JSON.parse(body);
              msg = errJson.error || msg;
              if (errJson.detail) msg += ` (${errJson.detail})`;
            } catch {
              if (body) msg = body;
            }
            throw new Error(msg);
          }

          statusEl.textContent = "Заявка отправлена. Мы свяжемся с вами.";
          form.reset();
          dateInput.value = today.toISOString().slice(0, 10);
          loadInstitutions();
        } catch (error) {
          statusEl.classList.add("form__status--error");
          statusEl.textContent = "Не удалось отправить заявку: " + error.message;
          console.error(error);
        }
      });
    })();
  </script>
</body>
</html>
