<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Регистрация | HelpWay</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <header class="header">
    <div class="container header__inner">
      <a class="logo" href="index.html">HelpWay</a>
      <nav class="nav" aria-label="Основная навигация">
        <a class="nav__link" href="index.html#about">О нас</a>
        <a class="nav__link" href="index.html#volunteers">Волонтерам</a>
        <a class="nav__link" href="index.html#clients">Клиентам</a>
      </nav>
      <div class="header__actions">
        <a class="btn btn--outline" href="index.html">На главную</a>
        <a class="btn btn--primary" href="login.html">Войти</a>
      </div>
    </div>
  </header>

  <main class="register">
    <div class="container">
      <div class="register__card">
        <h1 class="register__title">Регистрация</h1>

        <form id="registrationForm" class="form" novalidate>
          <p class="register__lead">Заполните форму, чтобы добавить себя в систему. Все поля обязательны.</p>

          <div class="form__group">
            <label for="role">В какой роли вы хотите зарегистрироваться</label>
            <select id="role" name="role" required>
              <option value="volunteer">Волонтер</option>
              <option value="client">Клиент</option>
            </select>
          </div>

          <div class="form__group">
            <label for="email">Почта</label>
            <input id="email" name="email" type="email" placeholder="you@example.com" required />
          </div>

          <div class="form__grid">
            <div class="form__group">
              <label for="l_name">Фамилия</label>
              <input id="l_name" name="l_name" type="text" placeholder="Иванов" required />
            </div>
            <div class="form__group">
              <label for="f_name">Имя</label>
              <input id="f_name" name="f_name" type="text" placeholder="Иван" required />
            </div>
          </div>

          <div class="form__group">
            <label for="password">Пароль</label>
            <input id="password" name="password" type="password" minlength="6" placeholder="Не менее 6 символов" required />
            <div class="form__hint">Пароль будет захеширован на сервере и сохранен в таблице password_hashes.</div>
          </div>

          <div class="form__group">
            <label for="city">Город</label>
            <select id="city" name="city" required>
              <option value="">Выберите город</option>
              <option value="Москва">Москва</option>
            </select>
          </div>

          <div class="form__group">
            <label for="address">Адрес (улица, дом)</label>
            <input id="address" name="address" type="text" placeholder="ул. Пример, д. 1" required />
          </div>

          <button class="btn btn--primary" type="submit">Зарегистрироваться</button>
          <p class="form__status" id="formStatus" aria-live="polite"></p>
        </form>

        <a class="back-link" href="index.html">&larr; Вернуться на главную</a>
      </div>
    </div>
  </main>

  <script>
    (() => {
      const params = new URLSearchParams(window.location.search);
      const roleParam = (params.get("role") || "").toLowerCase();
      const roleSelect = document.getElementById("role");
      const statusEl = document.getElementById("formStatus");
      const form = document.getElementById("registrationForm");

      const roleMap = {
        volunteer: "volunteer",
        волонтер: "volunteer",
        волонтёр: "volunteer",
        client: "client",
        клиент: "client"
      };

      if (roleParam && roleMap[roleParam]) {
        roleSelect.value = roleMap[roleParam];
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusEl.classList.remove("form__status--error");
        statusEl.textContent = "Сохраняем данные...";

        const payload = {
          role: roleSelect.value,
          email: form.email.value.trim(),
          l_name: form.l_name.value.trim(),
          f_name: form.f_name.value.trim(),
          city: form.city.value,
          address: form.address.value.trim(),
          password: form.password.value
        };

        try {
          const response = await fetch("api/register.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const body = await response.text();
            let msg = "Сервер вернул ошибку";
            try {
              const errJson = JSON.parse(body);
              msg = errJson.error || msg;
              if (errJson.detail) msg += ` (${errJson.detail})`;
            } catch {
              if (body) msg = body;
            }
            throw new Error(msg);
          }

          statusEl.textContent = "Регистрация прошла успешно. Теперь можно войти.";
          form.reset();
          roleSelect.value = payload.role;
        } catch (error) {
          statusEl.classList.add("form__status--error");
          statusEl.textContent = "Не удалось сохранить данные: " + error.message;
          console.error(error);
        }
      });
    })();
  </script>
</body>
</html>
