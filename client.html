<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Клиент | HelpWay</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body class="page-client">
  <header class="header">
    <div class="container header__inner">
      <a class="logo" href="client.html">HelpWay</a>

      <nav class="nav" aria-label="Основная навигация">
        <a class="nav__link" href="#my-requests">Мои заявки</a>
        <a class="nav__link" href="#nearby">Ближайшие учреждения</a>
      </nav>

      <div class="header__actions">
        <a class="avatar" href="profile.html?role=client" aria-label="Профиль">
          <img src="img/4.png" alt="Профиль" />
        </a>
      </div>
    </div>
  </header>

  <main>
    <section class="hero hero--client">
      <div class="hero__bg" aria-hidden="true"></div>
      <div class="hero__overlay"></div>

      <div class="container hero__inner">
        <div class="hero__content">
          <h1 class="hero__title">Вы не одни — мы рядом, чтобы помочь</h1>
          <p class="hero__subtitle">
            Оставьте заявку, расскажите о своих особенностях и мы подберем ближайшие учреждения, в которых вам окажут нужную помощь.
          </p>
          <div class="hero__actions">
            <a class="btn btn--primary btn--large" href="application.html">Отправить заявку</a>
          </div>
        </div>
      </div>
    </section>

    <section class="vol-section" id="my-requests">
      <div class="container">
        <h2 class="vol-section__title">Мои заявки</h2>
        <div class="table-wrapper">
          <table class="table" id="applicationsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Дата создания</th>
                <th>Тип ограничения</th>
                <th>Адрес клиента</th>
                <th>Учреждение</th>
                <th>Дата визита</th>
                <th>Статус</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7">Загружаем...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="vol-section" id="nearby">
      <div class="container">
        <h2 class="vol-section__title">Ближайшие учреждения</h2>
        <div id="map" class="map"></div>
        <div class="table-wrapper">
          <table class="table" id="nearestTable">
            <thead>
              <tr>
                <th>Название</th>
                <th>Адрес</th>
                <th>Расстояние</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3">Загрузка...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container footer__inner">
      <div class="footer__brand">HelpWay</div>
      <div class="footer__contacts">
        <div>Источник открытых данных: <a href="https://data.mos.ru/">data.mos.ru</a></div>
        <div>Email: <a href="mailto:info@helpway.ru">info@helpway.ru</a></div>
        <div>Адрес офиса: Москва, Рижский проезд, 15к1</div>
      </div>
    </div>
  </footer>

  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=0ef553e7-67a5-434b-9c61-f75cca415b38"></script>
  <script src="js/app-modal.js"></script>
  <script>
    (() => {
      const userId = localStorage.getItem("user_id");
      const tableBody = document.querySelector("#applicationsTable tbody");
      const nearestTableBody = document.querySelector("#nearestTable tbody");
      let mapInstance;
      const placemarks = [];
      let activePlacemark = null;

      if (!userId) {
        tableBody.innerHTML = '<tr><td colspan="7">Авторизуйтесь, чтобы просматривать заявки.</td></tr>';
        return;
      }

      const renderStatusIcon = (status, hasResponses) => {
        if (status === "closed") {
          return '<span class="status-icon status-icon--closed" title="Закрыта">✔</span>';
        }
        if (status === "confirmed") {
          return '<span class="status-icon status-icon--ok" title="Подтверждена">✔</span>';
        }
        if (hasResponses) {
          return '<span class="status-icon status-icon--responded" title="Есть отклик">&bull;</span>';
        }
        if (!status || status === "open") {
          return '<span class="status-icon status-icon--pending" title="Ожидает откликов">⏳</span>';
        }
        return '<span class="status-icon status-icon--ok" title="Подтверждена">✔</span>';
      };

      const loadApplications = () => {
        fetch(`api/applications.php?user_id=${encodeURIComponent(userId)}`)
          .then(async (res) => {
            const text = await res.text();
            if (!res.ok) {
              let msg = "Не удалось загрузить заявки";
              try { const j = JSON.parse(text); msg = j.error || msg; } catch { if (text) msg = text; }
              throw new Error(msg);
            }
            return JSON.parse(text);
          })
          .then((items) => {
            if (!Array.isArray(items) || !items.length) {
              tableBody.innerHTML = '<tr><td colspan="7">Пока заявок нет.</td></tr>';
              return;
            }
            tableBody.innerHTML = items.map((item) => {
              const endName = item.end_name || `${item.end_type} #${item.end_id}`;
              const goDate = item.go_date || "";
              const created = item.datetime || "";
              return `
                <tr class="table__row--clickable" data-id="${item.id}">
                  <td>${item.id}</td>
                  <td>${created}</td>
                  <td>${item.type || ""}</td>
                  <td>${item.start_address || ""}</td>
                  <td>${endName}</td>
                  <td>${goDate}</td>
                  <td>${renderStatusIcon(item.status, Number(item.has_responses) > 0)}</td>
                </tr>
              `;
            }).join("");

            document.querySelectorAll("#applicationsTable tbody tr.table__row--clickable").forEach((row) => {
            row.addEventListener("click", () => AppModal.open(row.dataset.id, { allowAccept: true, allowClose: true }));
          });
          })
          .catch((err) => {
            console.error(err);
          tableBody.innerHTML = `<tr><td colspan="7">${err.message}</td></tr>`;
        });
      };

      window.addEventListener("applications:updated", () => {
        loadApplications();
      });

      loadApplications();

      fetch(`api/nearest.php?user_id=${encodeURIComponent(userId)}`)
        .then(async (res) => {
          const text = await res.text();
          if (!res.ok) {
            let msg = "Не удалось загрузить ближайшие учреждения";
            try {
              const j = JSON.parse(text);
              msg = j.error || msg;
            } catch {
              if (text) msg = text;
            }
            throw new Error(msg);
          }
          return JSON.parse(text);
        })
        .then((data) => {
          if (!data.user || !data.points) return;
          ymaps.ready(() => {
            mapInstance = new ymaps.Map("map", {
              center: [data.user.lat, data.user.lon],
              zoom: 12
            });

            const userPlacemark = new ymaps.Placemark([data.user.lat, data.user.lon], {
              balloonContent: "Это вы"
            }, {
              preset: 'islands#redIcon'
            });
            mapInstance.geoObjects.add(userPlacemark);

            placemarks.length = 0;
            data.points.forEach((p, idx) => {
              const placemark = new ymaps.Placemark([p.lat, p.lon], {
                balloonContent: `<strong>${p.name || p.type}</strong><br>${p.address || ''}<br>${p.distance_km.toFixed(1)} км`
              }, {
                preset: 'islands#blueIcon'
              });
              placemark.__idx = idx;
              placemarks.push(placemark);
              mapInstance.geoObjects.add(placemark);
            });
          });
          if (nearestTableBody) {
            if (!data.points.length) {
              nearestTableBody.innerHTML = '<tr><td colspan="3">Нет учреждений рядом.</td></tr>';
              return;
            }
            nearestTableBody.innerHTML = data.points.map((p, idx) => {
              return `
                <tr class="table__row--clickable" data-idx="${idx}">
                  <td>${p.name || p.type}</td>
                  <td>${p.address || ''}</td>
                  <td>${p.distance_km.toFixed(1)} км</td>
                </tr>
              `;
            }).join("");

            nearestTableBody.querySelectorAll("tr.table__row--clickable").forEach((row) => {
              row.addEventListener("click", () => {
                const idx = Number(row.dataset.idx);
                const point = data.points[idx];
                const placemark = placemarks[idx];
                if (!mapInstance || !placemark || !point) return;
                if (activePlacemark && activePlacemark !== placemark) {
                  activePlacemark.options.set('preset', 'islands#blueIcon');
                }
                placemark.options.set('preset', 'islands#greenIcon');
                activePlacemark = placemark;
                mapInstance.setCenter([point.lat, point.lon], 14, { duration: 200 });
                placemark.balloon.open();
              });
            });
          }
        })
        .catch((err) => {
          console.error(err);
        });
    })();
  </script>
</body>
</html>
