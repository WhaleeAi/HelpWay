<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Кабинет клиента | HelpWay</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body class="page-client">
  <header class="header">
    <div class="container header__inner">
      <a class="logo" href="client.html">HelpWay</a>

      <nav class="nav" aria-label="Основная навигация">
        <a class="nav__link" href="#my-requests">Мои заявки</a>
        <a class="nav__link" href="#nearby">Ближайшие учреждения</a>
      </nav>

      <div class="header__actions">
        <a class="avatar" href="profile.html" aria-label="Профиль">
          <img src="api/image.php?id=3" alt="Профиль" />
        </a>
      </div>
    </div>
  </header>

  <main>
    <section class="hero hero--client">
      <div class="hero__bg" aria-hidden="true"></div>
      <div class="hero__overlay"></div>

      <div class="container hero__inner">
        <div class="hero__content">
          <h1 class="hero__title">Запишем вас туда, где нужна помощь</h1>
          <p class="hero__subtitle">
            Здесь вы оформите заявки, увидите ближайшие учреждения и сможете выбрать удобное время визита.
          </p>
          <div class="hero__actions">
            <a class="btn btn--primary btn--large" href="application.html">Оставить заявку</a>
          </div>
        </div>
      </div>
    </section>

    <section class="vol-section" id="my-requests">
      <div class="container">
        <h2 class="vol-section__title">Мои заявки</h2>
        <div class="table-wrapper">
          <table class="table" id="applicationsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Дата подачи</th>
                <th>Тип ограничений</th>
                <th>Адрес клиента</th>
                <th>Учреждение</th>
                <th>Дата визита</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6">Загрузка...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="vol-section" id="nearby">
      <div class="container">
        <h2 class="vol-section__title">Ближайшие учреждения</h2>
        <div id="map" class="map"></div>
        <div id="nearestCards" class="cards-grid cards-grid--5"></div>
      </div>
    </section>
  </main>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=0ef553e7-67a5-434b-9c61-f75cca415b38"></script>
  <script>
    (() => {
      const userId = localStorage.getItem("user_id");
      const tableBody = document.querySelector("#applicationsTable tbody");
      const cardsContainer = document.getElementById("nearestCards");

      if (!userId) {
        tableBody.innerHTML = '<tr><td colspan="6">Сначала войдите, чтобы увидеть заявки.</td></tr>';
        return;
      }

      fetch(`api/applications.php?user_id=${encodeURIComponent(userId)}`)
        .then(async (res) => {
          const text = await res.text();
          if (!res.ok) {
            let msg = "Ошибка загрузки заявок";
            try {
              const j = JSON.parse(text);
              msg = j.error || msg;
            } catch {
              if (text) msg = text;
            }
            throw new Error(msg);
          }
          return JSON.parse(text);
        })
        .then((items) => {
          if (!Array.isArray(items) || !items.length) {
            tableBody.innerHTML = '<tr><td colspan="6">Заявок пока нет.</td></tr>';
            return;
          }
          tableBody.innerHTML = items.map((item) => {
            const endName = item.end_name || `${item.end_type} #${item.end_id}`;
            const goDate = item.go_date || "";
            const created = item.datetime || "";
            return `
              <tr>
                <td>${item.id}</td>
                <td>${created}</td>
                <td>${item.type || ""}</td>
                <td>${item.start_adress || ""}</td>
                <td>${endName}</td>
                <td>${goDate}</td>
              </tr>
            `;
          }).join("");
        })
        .catch((err) => {
          console.error(err);
          tableBody.innerHTML = `<tr><td colspan="6">${err.message}</td></tr>`;
        });

      if (userId) {
        fetch(`api/nearest.php?user_id=${encodeURIComponent(userId)}`)
          .then(async (res) => {
            const text = await res.text();
            if (!res.ok) {
              let msg = "Не удалось загрузить ближайшие учреждения";
              try {
                const j = JSON.parse(text);
                msg = j.error || msg;
              } catch {
                if (text) msg = text;
              }
              throw new Error(msg);
            }
            return JSON.parse(text);
          })
          .then((data) => {
            if (!data.user || !data.points) return;
            ymaps.ready(() => {
           const map = new ymaps.Map("map", {
              center: [data.user.lat, data.user.lon],
              zoom: 12
            });

              const userPlacemark = new ymaps.Placemark([data.user.lat, data.user.lon], {
                balloonContent: "Вы здесь"
              }, {
                preset: 'islands#redIcon'
              });
              map.geoObjects.add(userPlacemark);

              data.points.forEach((p) => {
                const placemark = new ymaps.Placemark([p.lat, p.lon], {
                  balloonContent: `<strong>${p.name || p.type}</strong><br>${p.address || ''}<br>${p.distance_km.toFixed(1)} км`
                }, {
                  preset: 'islands#blueIcon'
                });
              map.geoObjects.add(placemark);
            });

            if (cardsContainer) {
              cardsContainer.innerHTML = data.points.map((p) => `
                <div class="card">
                  <div class="card__title">${p.name || p.type}</div>
                  <div class="card__text">${p.address || ''}</div>
                  <div class="card__meta">${p.metro ? `Метро: ${p.metro}` : 'Метро: не указано'}</div>
                  <div class="card__meta">~${p.distance_km.toFixed(1)} км</div>
                </div>
              `).join("");
            }
          });
        })
          .catch((err) => {
            console.error(err);
          });
      }
    })();
  </script>
</body>
</html>
