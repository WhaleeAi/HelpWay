<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Мои заявки | HelpWay</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <header class="header">
    <div class="container header__inner">
      <a class="logo" href="client.html">HelpWay</a>
      <nav class="nav" aria-label="Основная навигация">
        <a class="nav__link" href="applications.html">Все заявки</a>
        <a class="nav__link" href="profile.html">Профиль</a>
      </nav>
      <div class="header__actions">
        <a class="btn btn--primary" href="client.html">Главная</a>
      </div>
    </div>
  </header>

  <main class="register">
    <div class="container">
      <div class="applications__card">
        <h1 class="register__title">Мои заявки</h1>
        <p class="register__lead">Нажмите на строку, чтобы открыть карточку заявки и выбрать волонтёра.</p>

        <form id="applicationsFilters" class="form">
          <div class="form__grid">
            <div class="form__group">
              <label for="filterDateFrom">Дата заявки (с)</label>
              <input id="filterDateFrom" type="date" />
            </div>
            <div class="form__group">
              <label for="filterDateTo">Дата заявки (по)</label>
              <input id="filterDateTo" type="date" />
            </div>
            <div class="form__group">
              <label for="filterVisitFrom">Дата визита (с)</label>
              <input id="filterVisitFrom" type="date" />
            </div>
            <div class="form__group">
              <label for="filterVisitTo">Дата визита (по)</label>
              <input id="filterVisitTo" type="date" />
            </div>
            <div class="form__group">
              <label for="filterType">Тип ограничений</label>
              <input id="filterType" type="text" placeholder="Например: слабовидящие" />
            </div>
            <div class="form__group">
              <label for="filterDistance">Отдаленность, км</label>
              <input id="filterDistance" type="number" min="0" step="0.1" placeholder="Например: 5" />
            </div>
          </div>
          <div class="filters__actions">
            <button class="btn btn--outline btn--small" type="submit">Применить</button>
            <button class="btn btn--outline btn--small" type="button" id="filtersReset">Сбросить</button>
          </div>
        </form>

        <div class="table-wrapper">
          <table class="table" id="userApplicationsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Дата создания</th>
                <th>Тип ограничения</th>
                <th>Адрес клиента</th>
                <th>Учреждение</th>
                <th>Дата визита</th>
                <th>Статус</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7">Загружаем...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="js/app-modal.js"></script>
  <script>
    (() => {
      const tableBody = document.querySelector("#userApplicationsTable tbody");
      const userId = localStorage.getItem("user_id");
      const filtersForm = document.getElementById("applicationsFilters");
      const filterDateFrom = document.getElementById("filterDateFrom");
      const filterDateTo = document.getElementById("filterDateTo");
      const filterVisitFrom = document.getElementById("filterVisitFrom");
      const filterVisitTo = document.getElementById("filterVisitTo");
      const filterType = document.getElementById("filterType");
      const filterDistance = document.getElementById("filterDistance");
      const filtersReset = document.getElementById("filtersReset");

      if (!userId) {
        tableBody.innerHTML = '<tr><td colspan="7">Нужно войти, чтобы смотреть заявки.</td></tr>';
        return;
      }

      const renderStatusIcon = (status, hasResponses) => {
        if (status === "closed") {
          return '<span class="status-icon status-icon--closed" title="Закрыта">✔</span>';
        }
        if (status === "confirmed") {
          return '<span class="status-icon status-icon--ok" title="Подтверждена">✔</span>';
        }
        if (hasResponses) {
          return '<span class="status-icon status-icon--responded" title="Есть отклик">&bull;</span>';
        }
        if (!status || status === "open") {
          return '<span class="status-icon status-icon--pending" title="Ожидает откликов">⏳</span>';
        }
        return '<span class="status-icon status-icon--ok" title="Подтверждена">✔</span>';
      };

      const buildParams = () => {
        const params = new URLSearchParams();
        params.set("user_id", userId);
        if (filterDateFrom?.value) params.set("date_from", filterDateFrom.value);
        if (filterDateTo?.value) params.set("date_to", filterDateTo.value);
        if (filterVisitFrom?.value) params.set("visit_from", filterVisitFrom.value);
        if (filterVisitTo?.value) params.set("visit_to", filterVisitTo.value);
        if (filterType?.value?.trim()) params.set("type", filterType.value.trim());
        if (filterDistance?.value) params.set("distance_km", filterDistance.value);
        return params.toString();
      };

      const load = async () => {
        try {
          const res = await fetch(`api/applications.php?${buildParams()}`);
          const text = await res.text();
          if (!res.ok) {
            let msg = "Не удалось загрузить заявки";
            try {
              const j = JSON.parse(text);
              msg = j.error || msg;
            } catch { if (text) msg = text; }
            throw new Error(msg);
          }
          const items = JSON.parse(text);
          if (!Array.isArray(items) || !items.length) {
            tableBody.innerHTML = '<tr><td colspan="7">Пока заявок нет.</td></tr>';
            return;
          }
          tableBody.innerHTML = items.map(item => {
            const endName = item.end_name || `${item.end_type} #${item.end_id}`;
            return `
              <tr class="table__row--clickable" data-id="${item.id}">
                <td>${item.id}</td>
                <td>${item.datetime || ""}</td>
                <td>${item.type || ""}</td>
                <td>${item.start_address || ""}</td>
                <td>${endName}</td>
                <td>${item.go_date || ""}</td>
                <td>${renderStatusIcon(item.status, Number(item.has_responses) > 0)}</td>
              </tr>
            `;
          }).join("");

          document.querySelectorAll("#userApplicationsTable tbody tr.table__row--clickable").forEach((row) => {
            row.addEventListener("click", () => AppModal.open(row.dataset.id, { allowAccept: true, allowClose: true }));
          });
        } catch (err) {
          console.error(err);
          tableBody.innerHTML = `<tr><td colspan="7">${err.message}</td></tr>`;
        }
      };

      const debounce = (fn, wait = 300) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      };

      if (filtersForm) {
        const scheduleLoad = debounce(load, 300);
        filtersForm.addEventListener("input", scheduleLoad);
        filtersForm.addEventListener("submit", (e) => {
          e.preventDefault();
          load();
        });
        if (filtersReset) {
          filtersReset.addEventListener("click", () => {
            filtersForm.reset();
            load();
          });
        }
      }

      window.addEventListener("applications:updated", () => {
        load();
      });

      load();
    })();
  </script>
</body>
</html>
