<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Все заявки | HelpWay</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <header class="header">
    <div class="container header__inner">
      <a class="logo" href="volunteer.html">HelpWay</a>
      <nav class="nav" aria-label="Основная навигация">
        <a class="nav__link" href="volView.html">Заявки</a>
        <a class="nav__link" href="profile.html">Профиль</a>
        <a class="nav__link" href="archive.html">Архив</a>
      </nav>
      <div class="header__actions">
        <a class="btn btn--primary" href="volunteer.html">Главная</a>
      </div>
    </div>
  </header>

  <main class="register">
    <div class="container">
      <div class="applications__card">
        <h1 class="register__title">Все заявки</h1>
        <p class="register__lead">Нажмите на строку, чтобы открыть карточку заявки и откликнуться.</p>

        <form id="applicationsFilters" class="form filters-form">
          <div class="filters-form__row">
            <div class="form__grid filters-form__grid">
            <div class="form__group">
              <label for="filterType">Тип ограничений</label>
              <select id="filterType">
                <option value="">Все типы</option>
                <option value="слабовидящие">Слабовидящие</option>
                <option value="опорно-двигательные">Опорно-двигательные</option>
                <option value="когнитивные">Когнитивные</option>
                <option value="слуховые">Слуховые</option>
                <option value="речевые">Речевые</option>
                <option value="множественные">Множественные</option>
              </select>
            </div>
            <div class="form__group">
              <label for="filterDistance">Отдаленность, км</label>
              <input id="filterDistance" type="number" min="0" step="0.1" placeholder="Например: 5" />
            </div>
          </div>
            <div class="filters__actions">
              <button class="btn btn--outline btn--small" type="submit">Применить</button>
              <button class="btn btn--outline btn--small" type="button" id="filtersReset">Сбросить</button>
            </div>
          </div>
        </form>

        <div class="table-wrapper">
          <table class="table" id="allApplicationsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th class="sortable" data-sort="datetime">
                  Дата создания
                  <span class="sort-indicator"></span>
                </th>
                <th>Тип ограничения</th>
                <th>Адрес клиента</th>
                <th>Учреждение</th>
                <th class="sortable" data-sort="go_date">
                  Дата визита
                  <span class="sort-indicator"></span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6">Загружаем...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <div class="modal" id="applicationModal" aria-hidden="true">
    <div class="modal__overlay" data-close="true"></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="appModalTitle">
      <div class="modal__header">
        <h3 class="modal__title" id="appModalTitle">Заявка</h3>
        <button class="modal__close" type="button" aria-label="Закрыть" data-close="true">&times;</button>
      </div>
      <div class="modal__body" id="appModalBody">Загружаем...</div>
      <div class="modal__footer" id="appModalFooter"></div>
    </div>
  </div>

  <script>
    (() => {
      const tableBody = document.querySelector("#allApplicationsTable tbody");
      const modal = document.getElementById("applicationModal");
      const modalBody = document.getElementById("appModalBody");
      const modalFooter = document.getElementById("appModalFooter");
      const userId = localStorage.getItem("user_id");
      const filtersForm = document.getElementById("applicationsFilters");
      const filterType = document.getElementById("filterType");
      const filterDistance = document.getElementById("filterDistance");
      const filtersReset = document.getElementById("filtersReset");
      
      // Переменные для сортировки
      let currentSortField = 'datetime';
      let currentSortOrder = 'DESC';

      const closeModal = () => {
        modal.classList.remove("is-active");
        document.body.style.overflow = "";
      };

      modal.addEventListener("click", (e) => {
        if (e.target.dataset.close) closeModal();
      });

      const renderApplication = (app) => {
        const endName = app.end_name || `${app.end_type || "место"} #${app.end_id || ""}`;
        const status = app.status || "pending";
        modalBody.innerHTML = `
          <div class="app-detail">
            <div class="app-detail__row"><span class="app-detail__label">Тип ограничения:</span><span>${app.type || "—"}</span></div>
            <div class="app-detail__row"><span class="app-detail__label">Адрес клиента:</span><span>${app.start_address || "—"}</span></div>
            <div class="app-detail__row"><span class="app-detail__label">Учреждение:</span><span>${endName}</span></div>
            <div class="app-detail__row"><span class="app-detail__label">Дата визита:</span><span>${app.go_date || "—"}</span></div>
            <div class="app-detail__row"><span class="app-detail__label">Комментарий:</span><span>${app.comment || "—"}</span></div>
            <div class="app-detail__row"><span class="app-detail__label">Статус:</span><span class="badge">${status}</span></div>
          </div>
          <div class="form__group">
            <label for="respondMessage">Сообщение клиенту</label>
            <textarea id="respondMessage" rows="3" placeholder="Напишите, чем сможете помочь"></textarea>
          </div>
        `;

        modalFooter.innerHTML = `
          <button class="btn btn--outline btn--small" type="button" data-close="true">Закрыть</button>
          <button class="btn btn--primary btn--small" type="button" id="respondBtn">Откликнуться</button>
        `;

        const respondBtn = document.getElementById("respondBtn");
        respondBtn.addEventListener("click", async () => {
          if (!userId) {
            alert("Нужно войти как волонтер, чтобы откликаться.");
            return;
          }
          respondBtn.disabled = true;
          respondBtn.textContent = "Отправляем...";
          const answer = document.getElementById("respondMessage").value.trim() || "Готов помочь";
          try {
            const res = await fetch("api/application_respond.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                application_id: app.id,
                volunteer_id: Number(userId),
                answer
              })
            });
            const text = await res.text();
            if (!res.ok) {
              let msg = "Не удалось отправить отклик";
              try { const j = JSON.parse(text); msg = j.error || msg; } catch { if (text) msg = text; }
              throw new Error(msg);
            }
            respondBtn.textContent = "Отклик отправлен";
          } catch (err) {
            alert(err.message);
            respondBtn.disabled = false;
            respondBtn.textContent = "Откликнуться";
          }
        });
      };

      const openApplication = async (id) => {
        modal.classList.add("is-active");
        document.body.style.overflow = "hidden";
        modalBody.textContent = "Загружаем...";
        modalFooter.innerHTML = "";
        try {
          const res = await fetch(`api/application_detail.php?id=${encodeURIComponent(id)}`);
          const text = await res.text();
          if (!res.ok) {
            let msg = "Не удалось загрузить заявку";
            try { const j = JSON.parse(text); msg = j.error || msg; } catch { if (text) msg = text; }
            throw new Error(msg);
          }
          const data = JSON.parse(text);
          renderApplication(data.application);
        } catch (err) {
          modalBody.textContent = err.message;
        }
      };

      const buildParams = () => {
        const params = new URLSearchParams();
        params.set("limit", "200");
        params.set("sort_by", currentSortField);
        params.set("sort_order", currentSortOrder);
        
        if (userId) params.set("viewer_id", userId);
        if (filterType?.value?.trim()) params.set("type", filterType.value.trim());
        if (filterDistance?.value) params.set("distance_km", filterDistance.value);
        return params.toString();
      };

      // Функция для обновления индикаторов сортировки
      const updateSortIndicators = () => {
        document.querySelectorAll('.sortable').forEach(th => {
          const indicator = th.querySelector('.sort-indicator');
          if (th.dataset.sort === currentSortField) {
            indicator.textContent = currentSortOrder === 'DESC' ? '▼' : '▲';
            indicator.style.opacity = '1';
          } else {
            indicator.textContent = '↕';
            indicator.style.opacity = '0.3';
          }
        });
      };

      const load = () => {
        fetch(`api/applications.php?${buildParams()}`)
          .then(async (res) => {
            const text = await res.text();
            if (!res.ok) {
              let msg = "Не удалось загрузить заявки";
              try { const j = JSON.parse(text); msg = j.error || msg; } catch { if (text) msg = text; }
              throw new Error(msg);
            }
            return JSON.parse(text);
          })
          .then((items) => {
            if (!Array.isArray(items) || !items.length) {
              tableBody.innerHTML = '<tr><td colspan="6">Пока нет доступных заявок.</td></tr>';
              return;
            }
            tableBody.innerHTML = items.map((item) => {
              const endName = item.end_name || `${item.end_type} #${item.end_id}`;
              return `
                <tr class="table__row--clickable" data-id="${item.id}">
                  <td>${item.id}</td>
                  <td>${item.datetime || ""}</td>
                  <td>${item.type || ""}</td>
                  <td>${item.start_address || ""}</td>
                  <td>${endName}</td>
                  <td>${item.go_date || ""}</td>
                </tr>
              `;
            }).join("");

            document.querySelectorAll("#allApplicationsTable tbody tr.table__row--clickable").forEach((row) => {
              row.addEventListener("click", () => openApplication(row.dataset.id));
            });
          })
          .catch((err) => {
            console.error(err);
            tableBody.innerHTML = `<tr><td colspan="6">${err.message}</td></tr>`;
          });
      };

      // Обработчики для сортировки
      document.querySelectorAll('#allApplicationsTable .sortable').forEach(th => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          const sortField = th.dataset.sort;
          
          if (currentSortField === sortField) {
            // Переключение порядка сортировки для того же поля
            currentSortOrder = currentSortOrder === 'DESC' ? 'ASC' : 'DESC';
          } else {
            // Установка нового поля сортировки (по умолчанию DESC)
            currentSortField = sortField;
            currentSortOrder = 'DESC';
          }
          
          updateSortIndicators();
          load();
        });
      });

      const debounce = (fn, wait = 300) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      };

      if (filtersForm) {
        const scheduleLoad = debounce(load, 300);
        filtersForm.addEventListener("input", scheduleLoad);
        filtersForm.addEventListener("submit", (e) => {
          e.preventDefault();
          load();
        });
        if (filtersReset) {
          filtersReset.addEventListener("click", () => {
            filtersForm.reset();
            load();
          });
        }
      }

      // Инициализация индикаторов сортировки
      updateSortIndicators();
      load();
    })();
  </script>
</body>
</html>
